sudo: required
dist: trusty
language: generic
services:
  - docker
env:
  global:
    - LANGUAGE=en LC_ALL=C LANG=C
    - ENC_REPO=http://repo.siwhine.net/encrypted/
    - secure: "euLxEEQY12f5ckbS9vt6byTHpCTMjkuSqcjj6L1r8UVO3SF/g9wxksvgbSO0ruwttzPZ8jzQtunK+TEB8yKvwrdbD/I6tL042yq6bcdM1vnWP1Y3Rnb4tb7IA0Ff5K5LsSUm2EW4IijJtnxTMhX+2U9rjbOO9OzjjJ7Gl1WdOy5MBqYm2kOXOZDI4Slez04IAnoV0N/TXQTedVl4EVMO9Y8OAVd13a+DzrvF1suhyF0neU9ksn0BfZy7qedgQ4sXOlObdrk/FY3k6FOuCwwlP+9KpNFp3AYy45keCjKT1bugpIrYQjv4/4KNPQVIiUVPXrUszkR35WjBPw85pSulQ3yNY6AlWup/1A6Xla2v9iEm5UZgnc4cjxmH9Mx2JKP9HMWc2JJXJp30Jy6bA1bRlERN7leC4WPPUgjnUtcbobbPoBWxAadjNnF4hg7Su4zzVZN31Lm+s7TTId0NXLjN4e7aGAcMcdepkFGDJXLEMME7X2Nz/Qg8VOcyYQkxVyNrpw2eaaHss7EH2P3IL1foSKPGQJ3w3xHkGiIG+1HUdtYR/euI6CNQ57epNp9CTL0W/P+7ofSux8WliZDqLTEIZ9Z2Uk5H4yXMNcqBIu0a1F7lkz1VLH9snToMjkknzC1qxLBFGzVUMJNv3Hm7mhslX4SsnVB5LsQTih+lWVFUJok="
  matrix:
    - DISTRO=edge-5 DIST=el5
    - DISTRO=edge-6 DIST=el6
    - DISTRO=edge-7 DIST=el7
before_install:
  - export PACKAGE=${TRAVIS_BRANCH}
  - if [ "${PACKAGE}" == "master" ]; then export PACKAGE=${DISTRO}-repo ; fi
  - if [ ! -d SOURCES/${PACKAGE} ] ; then mkdir SOURCES/${PACKAGE} ; fi
  - if [ -f SOURCES/${PACKAGE}.env ] ; then source SOURCES/${PACKAGE}.env ; fi
  - docker pull centos:latest
  - docker create --privileged=true --name centos_build -v $(pwd):/mock/build centos:latest bash -c 'while /bin/true ; do sleep 10 ; uptime ; done'
  - docker start centos_build
  - docker exec centos_build yum install -y mock spectool 
  - docker exec centos_build useradd mock -g mock -u ${UID}
  - if [ ! -z $encrypted_ddd175810ce0_key ]; then openssl aes-256-cbc -K $encrypted_ddd175810ce0_key -iv $encrypted_ddd175810ce0_iv -in deploy.key.enc -out deploy.key -d; fi
  - if [ ! -z $encrypted_ddd175810ce0_key ]; then chmod 600 deploy.key ; fi
  - if [ ! -z $encrypted_ddd175810ce0_key ]; then for RPM in ${THIRD_PARTY_RPMS}; do wget ${ENC_REPO}${RPM}.enc && openssl aes-256-cbc -K $encrypted_ddd175810ce0_key -iv $encrypted_ddd175810ce0_iv -in ${RPM}.enc -out ${RPM} -d ; docker exec centos_build yum -y --nogpgcheck install /mock/build/${RPM};  done; fi
script:
  - docker exec centos_build spectool -g -C /mock/build/SOURCES/${PACKAGE} /mock/build/SPECS/${PACKAGE}.spec
  - docker exec -u ${UID} centos_build /usr/bin/mock --configdir=/mock/build/conf -r ${DISTRO}-x86_64 --spec=/mock/build/SPECS/${PACKAGE}.spec --sources=/mock/build/SOURCES/${PACKAGE} --resultdir=/mock/build/SRPMS --buildsrpm
  - docker exec -u ${UID} centos_build /usr/bin/mock --clean --configdir=/mock/build/conf -r ${DISTRO}-x86_64  -D "dist .${DIST}" --resultdir=/mock/build/RPMS --rebuild /mock/build/SRPMS/$(ls -1 SRPMS/|grep src\.rpm$|head -1)
after_script:
  - docker stop centos_build
  - ls -lha SRPMS/ RPMS/*
after_failure:
  - tail -n 300 SRPMS/*log
  - tail -n 300 RPMS/*log
before_deploy:
  - export RELEASE_PKG_FILE=$(ls RPMS/`uname -m`/*.rpm SRPMS/*.rpm)
  - echo "deploying $RELEASE_PKG_FILE to GitHub releases"
deploy:
  - provider: script
    script: ./sync_repo.sh
    skip_cleanup: true
    on:
      repo: gboddin/edge-repo
      all_branches: true
