env:
  - DISTRO=centos-6 REDIS_VERSION=3.2.3 PHP_VERSION=5.6.25 APACHE_VERSION=2.4.23 PHP_CONFIG_FLAGS="--with httpd24 --with libgd"
  - DISTRO=centos-7 REDIS_VERSION=3.2.3 PHP_VERSION=5.6.25 APACHE_VERSION=2.4.23 PHP_CONFIG_FLAGS="--with httpd24 --with libgd"
install:
  - wget "https://github.com/gboddin/upsalter/releases/download/0.2.3/${DISTRO}-rootfs-salted.tar.bz2"
  - mkdir ${DISTRO} 
  - tar -C ${DISTRO} -xjf ${DISTRO}-rootfs-salted.tar.bz2
script:
  - echo ${APACHE_VERSION}|grep -q "^2.4" && ./${DISTRO}/proot -b $(pwd):/root/build -b /etc/hosts -b /etc/hostname -b /etc/resolv.conf -b /dev -w /root/build -r centos-7 -0 /bin/bash /root/build/build-apache.sh
  - echo ${APACHE_VERSION}|grep -q "^2.4" && ./${DISTRO}/proot -b $(pwd):/root/build -b /etc/hosts -b /etc/hostname -b /etc/resolv.conf -b /dev -w /root/build -r centos-7 -0 rpm -Uvh /root/build/RPMS/$(uname -m)/httpd-{,devel-}${APACHE_VERSION}-.*.$(uname -m).rpm
  - ./${DISTRO}/proot -b $(pwd):/root/build -b /etc/hosts -b /etc/hostname -b /etc/resolv.conf -b /dev -w /root/build -r centos-7 -0 /bin/bash /root/build/build-php.sh
  - ./${DISTRO}/proot -b $(pwd):/root/build -b /etc/hosts -b /etc/hostname -b /etc/resolv.conf -b /dev -w /root/build -r centos-7 -0 /bin/bash /root/build/build-redis.sh
  - echo ${APACHE_VERSION}|grep -q "^2.4" && cp SOURCES/httpd-php-build.conf ${DISTRO}/etc/httpd/conf/httpd.conf 
  - ./${DISTRO}/proot -b $(pwd):/root/build -b /etc/hosts -b /etc/hostname -b /etc/resolv.conf -b /dev -w /root/build -r centos-7 -0 rpm -Uvh /root/build/RPMS/$(uname -m)/*.rpm
before_deploy:
  - export RELEASE_PKG_FILE=$(ls RPMS/`uname -m`/*.rpm)
  - echo "deploying $RELEASE_PKG_FILE to GitHub releases"
deploy:
  file_glob: true
  file: "${RELEASE_PKG_FILE}"
  on:
    tags: true
  provider: releases
  api_key:
    secure: tMqvtlXtlFZesTKVQBG0xRuDcKvQzHl2vlWz43/CTQkjczlJT/KtExlbP0AJbFbYB0f2/qc+b5z0lIWp44lHwTBwlk1f2kSpAbhLmscj3fSTjhkSbq1PZId68d7ebOkKirXM+yxYGRvofqBEwKgHjEIs8ll5kEXV7QJFRc3TSe2lkji1+afB/IwyLO4si/cAx6yHwL4esVxnw9IsSqf320XThyJ+gJaq2/xuq+XRVRAkjBoEggdTlUtX4pBibnOLKkV3HjtgfluWJPpvAJmL9XnXvvLvTXEDwyf2LBdYKPF/J4R6IF/ry2n1YmgbquUXWc8iNtQ+h9ZiapblRm4nJNLvXwvwWuJ0YT1p8ZqNlhTT+TivKy13HBI6dJSirT+viEG8SR6deDIYmEHSWJoCym/JhlzzfAKTaqaZaSToZvRgr61+GY6iboKUAp1Tfn5WMEC67eN9p3jvigA2qvHncr8VfDcGF7pQKoU42u+y8ADBilkP8xmJ0umW/tZuvUzRh7CEeYCioBACyxHoklD0GWbTQEsVCWC3kMAhvAJdOLw6sLI+ThvyPwaI5sx5OHupSbxQMEDUjCe/nO94VQXOsgPUPiJ5DyOTlvp3XSjRQuCLCmGScbKtbuXfI87fHjCsxUtrveiPJt1BqDbZBfJg7fz6myKYq1AG5Ix085FXJY0=
